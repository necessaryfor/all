<?php

ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $database = $_POST['database'] ?? '';
    $user = $_POST['user'] ?? '';
    $pass = $_POST['pass'] ?? '';
    $host = $_POST['host'] ?? 'localhost';

    if (empty($database) || empty($user) || empty($pass)) {
        // Eğer gerekli bilgiler boşsa hata mesajı döner
        header('Content-Type: application/json');
        echo json_encode([
            'status' => 'error',
            'message' => 'Lütfen veritabanı adı, kullanıcı adı ve parola alanlarını doldurunuz.'
        ]);
        exit;
    }

    // Geçici bir dosyaya SQL dump yap
    $outputFile = tempnam(sys_get_temp_dir(), 'dump_') . ".sql";

    // mysqldump komutunu çalıştır ve çıktıyı geçici dosyaya kaydet
    exec("mysqldump --user={$user} --password='{$pass}' --host={$host} --no-tablespaces {$database} > {$outputFile} 2>&1", $output, $result_code);

    // Eğer mysqldump başarılı olduysa, dosyayı indir
    if ($result_code === 0) {
        // Dosya indirme başlıkları ayarla
        header('Content-Type: application/json');
        echo json_encode([
            'status' => 'success',
            'message' => 'SQL dump işlemi başarılı oldu!',
            'downloadUrl' => $outputFile
        ]);
    } else {
        // Hata mesajını döndür
        header('Content-Type: application/json');
        echo json_encode([
            'status' => 'error',
            'message' => 'SQL dump işlemi başarısız oldu: ' . implode("\n", $output)
        ]);
    }
    exit;
}

?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Backup</title>
    <script>
        function backupDatabase() {
            // Form verilerini oku
            var formData = new FormData();
            formData.append('database', document.getElementById('database').value);
            formData.append('user', document.getElementById('user').value);
            formData.append('pass', document.getElementById('pass').value);
            formData.append('host', document.getElementById('host').value);

            // Ajax isteği yap
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '', true);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    document.getElementById('output').innerHTML = response.message;

                    // Eğer başarılı ise dosyayı indir
                    if (response.status === 'success') {
                        var link = document.createElement('a');
                        link.href = response.downloadUrl;
                        link.download = document.getElementById('database').value + '_backup.sql';
                        link.click();
                    }
                }
            };
            xhr.send(formData);
        }
    </script>
</head>

<body>
    <h3>Veritabanı Yedekleme</h3>

    <!-- Bilgi giriş inputları -->
    <label for="database">Veritabanı Adı:</label>
    <input type="text" id="database" placeholder="Veritabanı adını girin"><br><br>

    <label for="user">Kullanıcı Adı:</label>
    <input type="text" id="user" placeholder="Kullanıcı adını girin"><br><br>

    <label for="pass">Parola:</label>
    <input type="password" id="pass" placeholder="Parolanızı girin"><br><br>

    <label for="host">Host:</label>
    <input type="text" id="host" value="localhost"><br><br>

    <!-- SQL Dump butonu -->
    <button onclick="backupDatabase()">SQL Dump Yap</button>

    <!-- Çıktılar -->
    <div id="output"></div>
</body>

</html>
