<?php

ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

// Eğer Ajax isteği geldiyse, SQL dump işlemini yap
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $database = $_POST['database'] ?? '';
    $user = $_POST['user'] ?? '';
    $pass = $_POST['pass'] ?? '';
    $host = $_POST['host'] ?? 'localhost';
    $dir = dirname(__FILE__) . '/database.sql';

    // mysqldump komutunu çalıştır ve çıktıyı yakala
    exec("mysqldump --user={$user} --password={$pass} --host={$host} --no-tablespaces {$database} --result-file={$dir} 2>&1", $output, $result_code);

    // Eğer mysqldump başarılı olduysa
    if ($result_code === 0) {
        // Dosya boyutunu al
        $filesize = filesize($dir);
        $details = [
            'status' => 'success',
            'file' => 'database.sql',
            'size' => round($filesize / 1024, 2) . ' KB', // Boyutu KB olarak hesaplar
            'message' => 'SQL dump işlemi başarılı oldu!'
        ];
    } else {
        // Hata oluştuysa çıktıyı ve kodu döner
        $details = [
            'status' => 'error',
            'message' => 'SQL dump işlemi başarısız oldu: ' . implode("\n", $output)
        ];
    }

    // JSON formatında sonuç döndür
    header('Content-Type: application/json');
    echo json_encode($details);
    exit;
}

?>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Backup</title>
    <script>
        function backupDatabase() {
            // Form verilerini oku
            var formData = new FormData();
            formData.append('database', document.getElementById('database').value);
            formData.append('user', document.getElementById('user').value);
            formData.append('pass', document.getElementById('pass').value);
            formData.append('host', document.getElementById('host').value);

            // Ajax isteği yap
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '', true);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    document.getElementById('output').innerHTML = response.message;

                    if (response.status === 'success') {
                        document.getElementById('details').innerHTML =
                            "Dosya adı: " + response.file + "<br>" +
                            "Boyut: " + response.size + "<br>" +
                            "<a href='" + response.file + "' download>SQL Yedeğini İndir</a>";
                    }
                }
            };
            xhr.send(formData);
        }
    </script>
</head>

<body>
    <h3>Veritabanı Yedekleme</h3>

    <!-- Bilgi giriş inputları -->
    <label for="database">Veritabanı Adı:</label>
    <input type="text" id="database" value="u714394017_edit1"><br><br>

    <label for="user">Kullanıcı Adı:</label>
    <input type="text" id="user" value="u714394017_edit1"><br><br>

    <label for="pass">Parola:</label>
    <input type="password" id="pass" value="$Fiu$Hq3K]f"><br><br>

    <label for="host">Host:</label>
    <input type="text" id="host" value="localhost"><br><br>

    <!-- SQL Dump butonu -->
    <button onclick="backupDatabase()">SQL Dump Yap</button>

    <!-- Çıktılar -->
    <div id="output"></div>
    <div id="details"></div>
</body>

</html>
